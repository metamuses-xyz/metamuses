name: Rollback Deployment

permissions:
  contents: read
  issues: write

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - production
          - staging
      backup_file:
        description: 'Backup filename (leave empty for latest)'
        required: false
        type: string
      confirm:
        description: 'Type "ROLLBACK" to confirm'
        required: true
        type: string

jobs:
  validate:
    name: Validate Rollback Request
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "ROLLBACK" ]; then
            echo "‚ùå Rollback not confirmed. Please type 'ROLLBACK' to confirm."
            exit 1
          fi
          echo "‚úÖ Rollback confirmed"

      - name: Display rollback info
        run: |
          echo "üîÑ Rollback Information"
          echo "======================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Backup file: ${{ inputs.backup_file || 'latest available' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date)"

  rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: [validate]
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
            SERVER_HOST="${{ secrets.SERVER_HOST }}"
            SERVER_USER="${{ secrets.SERVER_USER }}"
          else
            echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
            SERVER_HOST="${{ secrets.STAGING_HOST }}"
            SERVER_USER="${{ secrets.STAGING_USER }}"
          fi
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          echo "SERVER_HOST=$SERVER_HOST" >> $GITHUB_ENV
          echo "SERVER_USER=$SERVER_USER" >> $GITHUB_ENV

      - name: Create pre-rollback backup
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            cd /opt/metamuses

            echo "üì¶ Creating pre-rollback backup..."
            bash deployment/scripts/backup.sh
          ENDSSH

      - name: Execute rollback
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd /opt/metamuses

            echo "üîÑ Starting rollback process..."

            # Determine backup file
            BACKUP_FILE="${{ inputs.backup_file }}"
            if [ -z "$BACKUP_FILE" ]; then
              BACKUP_FILE=$(ls -t backups/metamuses_backup_*.tar.gz | head -1 | xargs basename)
              echo "Using latest backup: $BACKUP_FILE"
            fi

            if [ ! -f "backups/$BACKUP_FILE" ]; then
              echo "‚ùå Backup file not found: $BACKUP_FILE"
              exit 1
            fi

            # Stop services
            echo "‚è∏Ô∏è  Stopping services..."
            docker compose -f deployment/docker/docker-compose.production.yml down api

            # Restore from backup
            echo "üì• Restoring from backup: $BACKUP_FILE"
            bash deployment/scripts/restore.sh "$BACKUP_FILE"

            echo "‚úÖ Rollback completed"
          ENDSSH

      - name: Health check after rollback
        run: |
          echo "üè• Running health check..."

          if [ "${{ inputs.environment }}" = "production" ]; then
            HEALTH_URL="https://api.metamuses.xyz/health"
          else
            HEALTH_URL="https://staging-api.metamuses.xyz/health"
          fi

          sleep 15

          max_attempts=20
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."

            if curl -f -s "$HEALTH_URL" > /dev/null 2>&1; then
              echo "‚úÖ Health check passed after rollback!"
              curl -s "$HEALTH_URL"
              exit 0
            fi

            sleep 5
            attempt=$((attempt + 1))
          done

          echo "‚ùå Health check failed after rollback"
          exit 1

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [rollback]
    if: always()

    steps:
      - name: Send Slack notification
        if: always() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "MetaMuses API Rollback ${{ needs.rollback.result }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üîÑ MetaMuses API Rollback"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ needs.rollback.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ inputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Backup:*\n${{ inputs.backup_file || 'latest' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Actor:*\n${{ github.actor }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Rollback Failed: ${context.payload.inputs.environment}`,
              body: `## Rollback Failure Report

              **Environment**: ${context.payload.inputs.environment}
              **Backup File**: ${context.payload.inputs.backup_file || 'latest'}
              **Actor**: ${context.actor}
              **Workflow Run**: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

              The rollback process failed. Manual intervention may be required.

              ### Next Steps
              1. Check the workflow logs
              2. Verify server status
              3. Contact DevOps team if needed
              `,
              labels: ['bug', 'rollback', 'urgent']
            });
